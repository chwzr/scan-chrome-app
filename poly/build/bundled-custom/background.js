const FILE_SYSTEM_ID='scan';function sanitizeMetadata(a,b){return a.modificationTime=new Date(a.modificationTime),b&&(!b.name&&delete a.name,!b.thumbnail&&delete a.thumbnail,!b.size&&delete a.size,!b.mimeType&&delete a.mimeType,!b.modificationTime&&delete a.modificationTime,!b.isDirectory&&delete a.isDirectory),a}function onGetMetadataRequested(a,b,c){if(console.log('onGetMetadataRequested',a),'/'===a.entryPath){var d={isDirectory:!0,name:'',size:0,modificationTime:new Date};return void b(sanitizeMetadata(d,a))}chrome.storage.local.get(a.entryPath,function(d){var e=d[a.entryPath];e?b(sanitizeMetadata(e,a)):c('NOT_FOUND')})}function onReadDirectoryRequested(a,b){console.log('onReadDirectoryRequested',a),chrome.storage.local.get(null,function(c){var d=Object.keys(c).map(function(b){return sanitizeMetadata(c[b],a)});b(d,!1)})}var openedFiles={},openedBuffers={};function onOpenFileRequested(a,b){console.log('onOpenFileRequested',a),openedFiles[a.requestId]=a.filePath,b()}function onReadFileRequested(a,b,c){console.log('onReadFileRequested',a),chrome.storage.local.get(null,function(d){var e=openedFiles[a.openRequestId];if(!e)return void c('SECURITY');var f=dataURItoArrayBuffer(d[e].thumbnail);b(f.slice(a.offset,a.offset+a.length),!1)})}function onCloseFileRequested(a,b,c){if(console.log('onCloseFileRequested',a),!openedFiles[a.openRequestId])return void c('INVALID_OPERATION');if(openedBuffers[a.openRequestId]){for(var d=new Uint8Array(openedBuffers[a.openRequestId]),e=0,f='';e<d.byteLength;e++)f+=String.fromCharCode(d[e]);var g='data:image/png;base64,'+window.btoa(f),h=openedFiles[a.openRequestId];chrome.storage.local.get(h,function(c){c[h].thumbnail=g,c[h].modificationTime=new Date().toString(),chrome.storage.local.set(c,function(){chrome.fileSystemProvider.get(FILE_SYSTEM_ID,function(c){c.watchers.forEach(function(a){if(h.startsWith(a.entryPath)){var b={fileSystemId:FILE_SYSTEM_ID,observedPath:a.entryPath,recursive:a.recursive,changeType:'CHANGED'};chrome.fileSystemProvider.notify(b)}}),delete openedBuffers[a.openRequestId],delete openedFiles[a.openRequestId],b()})})})}else delete openedFiles[a.openRequestId],b()}function onMoveEntryRequested(a,b){console.log('onMoveEntryRequested',a),chrome.storage.local.get(a.sourcePath,function(c){var d={};d[a.targetPath]=c[a.sourcePath],d[a.targetPath].name=a.targetPath.substr(1),d[a.targetPath].modificationTime=new Date().toString(),chrome.storage.local.set(d,function(){chrome.storage.local.remove(a.sourcePath,function(){b()})})})}function onTruncateRequested(a,b){console.log('onTruncateRequested',a),b()}function onWriteFileRequested(a,b,c){if(console.log('onWriteFileRequested',a),!openedFiles[a.openRequestId])return void c('INVALID_OPERATION');if(0==a.offset)openedBuffers[a.openRequestId]=a.data,b();else if(!openedBuffers[a.openRequestId])c('INVALID_OPERATION');else{var d=new Blob([openedBuffers[a.openRequestId],a.data]),e=new FileReader;e.addEventListener('loadend',function(){openedBuffers[a.openRequestId]=e.result,b()}),e.readAsArrayBuffer(d)}}function onDeleteEntryRequested(a,b){console.log('onDeleteEntryRequested',a),chrome.storage.local.remove(a.entryPath,function(){b()})}function onAddWatcherRequested(a,b){console.log('onAddWatcherRequested',a),b()}function onRemoveWatcherRequested(a,b){console.log('onRemoveWatcherRequested',a),b()}function onUnmountRequested(a,b){console.log('onUnmountRequested',a),b(),chrome.fileSystemProvider.unmount({fileSystemId:a.fileSystemId})}function onMountRequested(a){console.log('onMountRequested'),a(),mountFileSystem()}function mountFileSystem(){chrome.fileSystemProvider.mount({fileSystemId:FILE_SYSTEM_ID,displayName:'Scan',writable:!0},function(){chrome.runtime.lastError&&console.log(chrome.runtime.lastError.message)})}function dataURItoArrayBuffer(a){for(var b=atob(a.split(',')[1]),c=new ArrayBuffer(b.length),d=new Uint8Array(c),e=0;e<b.length;e++)d[e]=b.charCodeAt(e);return d.buffer}function showWindow(){chrome.app.window.create('index.html',{innerBounds:{width:640,height:640},resizable:!1,frame:'none',hidden:!0})}function onMessage(a){'mountFileSystem'===a.action&&mountFileSystem()}chrome.fileSystemProvider.onGetMetadataRequested.addListener(onGetMetadataRequested),chrome.fileSystemProvider.onReadDirectoryRequested.addListener(onReadDirectoryRequested),chrome.fileSystemProvider.onOpenFileRequested.addListener(onOpenFileRequested),chrome.fileSystemProvider.onReadFileRequested.addListener(onReadFileRequested),chrome.fileSystemProvider.onCloseFileRequested.addListener(onCloseFileRequested),chrome.fileSystemProvider.onDeleteEntryRequested.addListener(onDeleteEntryRequested),chrome.fileSystemProvider.onMoveEntryRequested.addListener(onMoveEntryRequested),chrome.fileSystemProvider.onWriteFileRequested.addListener(onWriteFileRequested),chrome.fileSystemProvider.onTruncateRequested.addListener(onTruncateRequested),chrome.fileSystemProvider.onAddWatcherRequested.addListener(onAddWatcherRequested),chrome.fileSystemProvider.onRemoveWatcherRequested.addListener(onRemoveWatcherRequested),chrome.fileSystemProvider.onMountRequested.addListener(onMountRequested),chrome.fileSystemProvider.onUnmountRequested.addListener(onUnmountRequested),chrome.app.runtime.onLaunched.addListener(showWindow),chrome.runtime.onMessage.addListener(onMessage);